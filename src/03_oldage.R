library(tidycensus)
library(tidyverse)
library(sf)


# Get ACS older adult characteristics


# API key ------------------------------------------------------------------------
#

# installed census api key
readRenviron("~/.Renviron")
Sys.getenv("CENSUS_API_KEY")


#
# Select variables ------------------------------------------------------------------------
#

acs_older_vars <- c(
  # Total older adults
  "B01001_020", "B01001_021", "B01001_022", "B01001_023", "B01001_024", "B01001_025",
  "B01001_044", "B01001_045", "B01001_046", "B01001_047", "B01001_048", "B01001_049", "B01001_001",
  # HI males age 65 +
  "B27001_024","B27001_026","B27001_027", "B27001_029",
  # HI females 65+
  "B27001_052","B27001_054","B27001_055" ,"B27001_057",
  # HEALTH STATUS
  "B18103_015", "B18103_016", "B18103_018", "B18103_019", "B18103_034", "B18103_035", "B18103_037", "B18103_038", 
  "B18102_015", "B18102_016", "B18102_018", "B18102_019", "B18102_034", "B18102_035", "B18102_037", "B18102_038", 
  "B18104_012", "B18104_013", "B18104_015", "B18104_016", "B18104_028", "B18104_029", "B18104_031", "B18104_032", 
  "B18105_012", "B18105_013", "B18105_015", "B18105_016", "B18105_028", "B18105_029", "B18105_031", "B18105_032", 
  "B18106_012", "B18106_013", "B18106_015", "B18106_016", "B18106_028", "B18106_029", "B18106_031", "B18106_032", 
  "B18107_009", "B18107_010", "B18107_012", "B18107_013", "B18107_022", "B18107_023", "B18107_025", "B18107_026", 
  "B18101_015", "B18101_016", "B18101_018", "B18101_019", "B18101_034", "B18101_035", "B18101_037", "B18101_038",
  #SNAP Hardship
  "B22001_003","B22001_006",
  #BELOW POVERTY
  "B17001_015","B17001_016", "B17001_029", "B17001_030", "B17001_044", "B17001_045", "B17001_058", "B17001_059",
  #HOUSEHOLDS
  "B11006_001","B11006_002", "B11006_004","B11006_005", "B11006_008",
  #EMPLOYMENT
  "B23001_073", "B23001_074", "B23001_078", "B23001_079", "B23001_083", "B23001_084", "B23001_159", "B23001_160", "B23001_164", 
  "B23001_165", "B23001_169", "B23001_170"
)


#
# Get data ------------------------------------------------------------------------
#

# Get county FIPS
countyfips <- get(data("fips_codes")) %>% filter(state == "VA")
countyfips <- countyfips$county_code

# Get data from 2014/18 5-year estimates at tract level
older_data_tract <- get_acs(geography = "tract", state = 51, county = countyfips,
                            variables = acs_older_vars,
                            year = 2018, survey = "acs5",
                            cache_table = TRUE, output = "wide", geometry = TRUE,
                            keep_geo_vars = TRUE)


#
# Calculate ------------------------------------------------------------------------
#

# Tract level
acs_older_tract <- older_data_tract %>% transmute(
  STATEFP = STATEFP,
  COUNTYFP = COUNTYFP,
  TRACTCE = TRACTCE,
  GEOID = GEOID,
  NAME.x = NAME.x,
  NAME.y = NAME.y,
  ALAND = ALAND,
  AWATER = AWATER,
  geometry = geometry,
  # TOTAL OLDER ADULTS
  older = (B01001_020E + B01001_021E + B01001_022E + B01001_023E + B01001_024E + B01001_025E +
           B01001_044E + B01001_045E + B01001_046E + B01001_047E + B01001_048E + B01001_049E) / B01001_001E * 100,
  #HEALTH INSURANCE
  nohealthins = (B27001_026E + B27001_029E + B27001_054E + B27001_057E) / (B27001_052E + B27001_055E + B27001_024E + B27001_027E) * 100,
  #HEALTH STATUS
  visdiff = (B18103_016E + B18103_019E + B18103_035E + B18103_038E) / (B18103_015E + B18103_018E + B18103_034E + B18103_037E) * 100,
  heardiff = (B18102_016E + B18102_019E + B18102_035E + B18102_038E) / (B18102_015E + B18102_018E + B18102_034E + B18102_037E) * 100,
  cogdiff = (B18104_013E + B18104_016E + B18104_029E + B18104_032E) / (B18104_012E + B18104_015E + B18104_028E + B18104_031E) * 100,
  ambdiff = (B18105_013E + B18105_016E + B18105_029E + B18105_032E) / (B18105_012E + B18105_015E + B18105_028E + B18105_031E) * 100,
  carediff = (B18106_013E + B18106_016E + B18106_029E + B18106_032E) / (B18106_012E + B18106_015E + B18106_028E + B18106_031E) * 100,
  ildiff = (B18107_010E + B18107_013E + B18107_023E + B18107_026E) / (B18107_009E + B18107_012E + B18107_022E + B18107_025E) * 100,
  disab = (B18101_016E + B18101_019E + B18101_035E + B18101_038E) / (B18101_015E + B18101_018E + B18101_034E + B18101_037E) * 100,
  #HARDSHIPS
  snap = B22001_003E / (B22001_006E + B22001_003E) * 100,
  inpov = (B17001_029E + B17001_030E + B17001_015E + B17001_016E) / (B17001_015E + B17001_016E + B17001_029E + B17001_030E + B17001_044E + B17001_045E + B17001_058E + B17001_059E) * 100,
  #HOUSEHOLDS
  hhsixty_total = B11006_002E / B11006_001E * 100,
  hhsixty_marr = B11006_004E / B11006_003E * 100,
  hhsixty_single = B11006_005E / B11006_003E * 100,
  hhsixty_nonfam = B11006_008E / B11006_003E * 100,
  #EMPLOYMENT
  labfor = (B23001_160E + B23001_165E + B23001_170E + B23001_074E + B23001_079E + B23001_084E) / (B23001_159E + B23001_164E + B23001_169E + B23001_073E + B23001_078E + B23001_083E) * 100
)
